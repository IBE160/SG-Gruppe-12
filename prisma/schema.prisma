// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Role enum for RBAC
enum UserRole {
  USER
  ADMIN
}

model User {
  id                      String                @id @default(uuid())
  name                    String
  email                   String                @unique
  password_hash           String // Renamed from passwordHash
  created_at              DateTime              @default(now())
  updated_at              DateTime              @updatedAt @default(now())

  // New fields from userRepository
  firstName               String? // Optional as per CreateUserData
  lastName                String? // Optional
  phoneNumber             String? // Optional
  emailVerificationToken  String? // Optional
  emailVerified           Boolean               @default(false)

  consent_essential       Boolean               @default(true)
  consent_ai_training     Boolean               @default(false)
  consent_marketing       Boolean               @default(false)

  cvs                     Cv[]
  job_postings            JobPosting[]
  application_analyses    ApplicationAnalysis[]

  @@map("users")
}

model Cv {
  id            Int      @id @default(autoincrement())
  user_id       String
  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  title         String?  // Made nullable
  file_path     String?  // Path to the original uploaded file in Supabase

  // Direct storage of CV data as JSONB
  personal_info Json?
  education     Json?
  experience    Json?
  skills        Json?
  languages     Json?
  summary       String?

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  application_analyses ApplicationAnalysis[]
  versions             CvVersion[]

  @@map("cvs")
}

model JobPosting {
  id            Int      @id @default(autoincrement())
  user_id       String?
  user          User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  title         String
  company       String?
  description   String
  url           String?
  created_at    DateTime @default(now())

  application_analyses ApplicationAnalysis[]

  @@map("job_postings")
}

model ApplicationAnalysis {
  id                            Int      @id @default(autoincrement())
  user_id                       String
  user                          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  cv_id                         Int
  cv                            Cv       @relation(fields: [cv_id], references: [id])
  job_posting_id                Int
  job_posting                   JobPosting @relation(fields: [job_posting_id], references: [id])
  generated_application_content String?
  generated_cv_content          String?
  ats_feedback                  Json?
  quality_feedback              Json?
  created_at                    DateTime @default(now())

  @@map("application_analyses")
}

model CvVersion {
  id             Int      @id @default(autoincrement())
  cv_id          Int
  cv             Cv       @relation(fields: [cv_id], references: [id], onDelete: Cascade)
  version_number Int
  snapshot       Json     // Stores the full CV data as a snapshot
  created_at     DateTime @default(now())

  @@unique([cv_id, version_number]) // Ensure unique version numbers per CV
  @@map("cv_versions")
}

// Audit log for security events (Story 5.6)
model AuditLog {
  id          Int      @id @default(autoincrement())
  user_id     String?  // Nullable for unauthenticated events (failed login attempts)
  action      String   // e.g., 'LOGIN', 'LOGOUT', 'PASSWORD_CHANGE', 'DATA_EXPORT', 'ACCOUNT_DELETE'
  resource    String?  // e.g., 'user', 'cv', 'application'
  resource_id String?  // ID of the affected resource
  ip_address  String?  // Client IP address
  user_agent  String?  // Browser/client user agent
  metadata    Json?    // Additional context (redacted PII)
  status      String   // 'SUCCESS', 'FAILURE', 'BLOCKED'
  created_at  DateTime @default(now())

  @@index([user_id, created_at])
  @@index([action, created_at])
  @@index([created_at])
  @@map("audit_logs")
}

// Consent change log for GDPR compliance (Story 5.1)
model ConsentLog {
  id           Int      @id @default(autoincrement())
  user_id      String
  consent_type String   // 'essential', 'ai_training', 'marketing'
  granted      Boolean  // true = opted in, false = opted out
  ip_address   String?  // Client IP address for audit trail
  timestamp    DateTime @default(now())

  @@index([user_id, timestamp])
  @@index([timestamp])
  @@map("consent_logs")
}