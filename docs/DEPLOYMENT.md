# Production Deployment Guide

This guide covers deploying the AI CV Assistant application to production using **Vercel** (frontend), **Render** (backend), and **Supabase** (database).

## Table of Contents

- [Prerequisites](#prerequisites)
- [1. Supabase Database Setup](#1-supabase-database-setup)
- [2. Backend Deployment (Render)](#2-backend-deployment-render)
- [3. Frontend Deployment (Vercel)](#3-frontend-deployment-vercel)
- [4. Post-Deployment Configuration](#4-post-deployment-configuration)
- [5. Verification & Testing](#5-verification--testing)
- [6. Monitoring & Maintenance](#6-monitoring--maintenance)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

Before deploying, ensure you have:

- [ ] GitHub repository with your code
- [ ] Supabase account ([supabase.com](https://supabase.com))
- [ ] Render account ([render.com](https://render.com))
- [ ] Vercel account ([vercel.com](https://vercel.com))
- [ ] Google AI API key ([makersuite.google.com](https://makersuite.google.com))
- [ ] (Optional) Sentry account for error tracking ([sentry.io](https://sentry.io))

---

## 1. Supabase Database Setup

### 1.1 Create Supabase Project

1. Go to [supabase.com](https://supabase.com) and sign in
2. Click **New Project**
3. Configure your project:
   - **Name**: `ai-cv-assistant-prod`
   - **Database Password**: Generate a strong password (save this!)
   - **Region**: Choose closest to your users
   - **Pricing Plan**: Free tier is sufficient for MVP

### 1.2 Get Database Connection String

1. In your Supabase project, go to **Settings** → **Database**
2. Scroll to **Connection String** section
3. Copy the **Connection string** (Transaction pooler mode)
4. Replace `[YOUR-PASSWORD]` with your database password
5. Save this connection string - you'll need it for Render

```
postgresql://postgres:Flesland2026@db.qtxqksjvrmqiuocxdqbn.supabase.co:5432/postgres
```

### 1.3 Run Database Migrations

You'll run migrations after deploying the backend. For now, just ensure you have your connection string ready.

### 1.4 Security Configuration

1. Go to **Authentication** → **URL Configuration**
2. Add your frontend URL to **Redirect URLs**
3. Go to **API Settings**
4. Note your `anon` and `service_role` keys (you may need these later)

---
anon :eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0eHFrc2p2cm1xaXVvY3hkcWJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Njc4MDQsImV4cCI6MjA4MDM0MzgwNH0._kJEacyaAxknUUswu08cqnV-3HG4ik2pCmPqb0L5kso
service role: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0eHFrc2p2cm1xaXVvY3hkcWJuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDc2NzgwNCwiZXhwIjoyMDgwMzQzODA0fQ.NyOFxknqP0lv42zlbFyJgnqWKTyjgH5XW_w1nkB5aDI
---

## 2. Backend Deployment (Render)

### 2.1 Create Render Account & Connect GitHub

1. Go to [render.com](https://render.com) and sign up
2. Click **Dashboard** → **New** → **Blueprint**
3. Connect your GitHub repository
4. Select the repository: `IBE160/SG-Gruppe-12`

### 2.2 Deploy Using Blueprint

Render will automatically detect the `render.yaml` file in your repository.

1. **Review the configuration:**
   - Web Service: `aicv-backend-api`
   - Redis: `aicv-redis`

2. **Set environment variables:**

   Click on the web service and go to **Environment**. Add these variables:

   | Variable | Value | Notes |
   |----------|-------|-------|
   | `DATABASE_URL` | Your Supabase connection string | From Step 1.2 |
   | `FRONTEND_URL` | `https://your-app.vercel.app` | You'll update this after Vercel deployment |
   | `GOOGLE_AI_API_KEY` | Your Google AI API key | From Google AI Studio |
   | `SENTRY_DSN` | Your Sentry DSN (optional) | Leave empty if not using Sentry |

   **Note:** `ACCESS_TOKEN_SECRET`, `REFRESH_TOKEN_SECRET`, and `ENCRYPTION_KEY` will be auto-generated by Render.

3. **Deploy:**
   - Click **Apply** to start deployment
   - Wait 5-10 minutes for the build to complete

### 2.3 Run Database Migrations

After the backend is deployed:

1. Go to your Render service dashboard
2. Click **Shell** to open a terminal
3. Run the following commands:

```bash
cd src
npx prisma migrate deploy
npx prisma db seed  # If you have seed data
```

### 2.4 Get Backend URL

1. Your backend will be deployed at: `https://aicv-backend-api.onrender.com`
2. Save this URL - you'll need it for Vercel

---

## 3. Frontend Deployment (Vercel)

### 3.1 Connect Repository to Vercel

1. Go to [vercel.com](https://vercel.com) and sign in
2. Click **New Project**
3. Import your GitHub repository: `IBE160/SG-Gruppe-12`
4. Vercel will auto-detect Next.js configuration

### 3.2 Configure Build Settings

1. **Root Directory**: `frontend`
2. **Framework Preset**: Next.js
3. **Build Command**: `npm run build` (auto-detected)
4. **Output Directory**: `.next` (auto-detected)

### 3.3 Set Environment Variables

In the **Environment Variables** section, add:

| Variable | Value | Notes |
|----------|-------|-------|
| `NEXT_PUBLIC_API_BASE_URL` | `https://aicv-backend-api.onrender.com/api/v1` | Your Render backend URL |
| `NEXT_PUBLIC_APP_ENV` | `production` | |
| `NEXT_PUBLIC_APP_NAME` | `AI CV Assistant` | |

### 3.4 Deploy

1. Click **Deploy**
2. Wait 2-3 minutes for the build to complete
3. Your app will be live at: `https://your-app.vercel.app`

---

## 4. Post-Deployment Configuration

### 4.1 Update Backend CORS

1. Go back to your Render backend service
2. Update the `FRONTEND_URL` environment variable to your Vercel URL
3. Click **Save Changes** (this will redeploy the backend)

### 4.2 Configure Custom Domain (Optional)

#### For Vercel (Frontend):
1. Go to **Settings** → **Domains**
2. Add your custom domain
3. Follow DNS configuration instructions

#### For Render (Backend):
1. Go to **Settings** → **Custom Domains**
2. Add your backend subdomain (e.g., `api.yourdomain.com`)

### 4.3 Enable HTTPS

Both Vercel and Render automatically provision SSL certificates. Ensure:
- Frontend uses HTTPS: `https://your-app.vercel.app`
- Backend uses HTTPS: `https://aicv-backend-api.onrender.com`

---

## 5. Verification & Testing

### 5.1 Health Checks

1. **Backend Health:**
   ```bash
   curl https://aicv-backend-api.onrender.com/
   ```
   Expected: `CV Analyzer API is running...`

2. **Frontend Health:**
   - Visit `https://your-app.vercel.app`
   - Should load without errors

### 5.2 Test Core Functionality

1. **User Registration:**
   - Create a new account
   - Verify email authentication works

2. **CV Upload:**
   - Upload a test CV (PDF format)
   - Verify AI parsing works

3. **Job Analysis:**
   - Submit a job description
   - Verify match score calculation
   - Check ATS score generation

4. **Download:**
   - Generate and download a tailored CV
   - Verify PDF generation works

### 5.3 Monitor Logs

#### Render Backend Logs:
1. Go to Render service dashboard
2. Click **Logs**
3. Monitor for errors during testing

#### Vercel Frontend Logs:
1. Go to Vercel project dashboard
2. Click **Deployments** → Select latest deployment
3. Click **Functions** to see serverless function logs

---

## 6. Monitoring & Maintenance

### 6.1 Set Up Sentry (Recommended)

1. Create a Sentry project at [sentry.io](https://sentry.io)
2. Get your DSN from **Settings** → **Client Keys**
3. Add `SENTRY_DSN` to Render environment variables
4. Redeploy backend

### 6.2 Database Backups

Supabase automatically backs up your database daily. To configure:
1. Go to Supabase **Database** → **Backups**
2. Review backup schedule
3. Test restore process

### 6.3 Redis Persistence

Render Redis on the free tier does not persist data. For production:
1. Upgrade to Standard or Pro plan
2. Or use external Redis provider (Upstash, Redis Cloud)

### 6.4 Rate Limit Monitoring

Monitor rate limit hits:
1. Check backend logs for rate limit errors
2. Adjust limits in `src/middleware/rate-limit.middleware.ts` if needed
3. Consider upgrading to higher Redis tier for more capacity

### 6.5 Cost Management

**Free Tier Limits:**
- **Supabase:** 500MB database, 2GB bandwidth
- **Render:** 750 hours/month (one service), 100GB bandwidth
- **Vercel:** 100GB bandwidth, 6,000 build minutes
- **Google AI:** Pay-per-use (monitor usage in Google Cloud Console)

**Monitoring:**
- Set up billing alerts in each service
- Review usage monthly
- Optimize API calls to reduce AI costs

---

## Troubleshooting

### Issue: Backend health check failing

**Solution:**
1. Check Render logs for startup errors
2. Verify `DATABASE_URL` is correctly set
3. Ensure Prisma migrations ran successfully
4. Check Redis connection

```bash
# In Render Shell
cd src
npx prisma migrate status
```

### Issue: CORS errors in browser

**Solution:**
1. Verify `FRONTEND_URL` in Render backend matches Vercel deployment
2. Check backend logs for CORS configuration
3. Ensure credentials are set to `true` in CORS config

### Issue: AI processing fails

**Solution:**
1. Verify `GOOGLE_AI_API_KEY` is correctly set
2. Check API key has billing enabled
3. Monitor API quota in Google Cloud Console
4. Review backend logs for AI provider errors

### Issue: Database connection errors

**Solution:**
1. Verify Supabase connection string format
2. Check database password is correct (no special characters that need URL encoding)
3. Ensure connection pooler mode is used (port 6543, not 5432)
4. Test connection from Render Shell:

```bash
cd src
npx prisma db pull
```

### Issue: Build fails on Render

**Solution:**
1. Check `package.json` scripts are correct
2. Verify `tsconfig.json` paths
3. Clear cache and redeploy
4. Check Node version compatibility

### Issue: Environment variable not updating

**Solution:**
1. After changing env vars in Render, click **Save Changes**
2. Wait for automatic redeploy (or trigger manual redeploy)
3. Clear browser cache for frontend changes
4. Check case sensitivity of variable names

---

## Production Checklist

Before going live:

- [ ] All secrets are strong random values (not defaults)
- [ ] `NODE_ENV` is set to `production`
- [ ] HTTPS is enabled on both frontend and backend
- [ ] CORS is configured correctly
- [ ] Database migrations are applied
- [ ] Error tracking (Sentry) is configured
- [ ] Backups are configured
- [ ] Health checks are passing
- [ ] Rate limits are appropriate
- [ ] All tests pass (`npm test`)
- [ ] Security headers are configured
- [ ] Sensitive data is encrypted at rest
- [ ] Billing alerts are set up
- [ ] Documentation is updated

---

## Support & Resources

- **Vercel Docs:** [vercel.com/docs](https://vercel.com/docs)
- **Render Docs:** [render.com/docs](https://render.com/docs)
- **Supabase Docs:** [supabase.com/docs](https://supabase.com/docs)
- **Project Repository:** [github.com/IBE160/SG-Gruppe-12](https://github.com/IBE160/SG-Gruppe-12)

For issues, create a GitHub issue in the project repository.
