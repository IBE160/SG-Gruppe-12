<story-context id="epic5/story-5-1" v="1.0">
  <metadata>
    <epicId>epic-5</epicId>
    <storyId>5-1</storyId>
    <title>GDPR Consent Management</title>
    <status>done</status>
    <generatedAt>2025-12-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-1-gdpr-consent-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>clear and granular control over my data consent preferences, including how my data is processed by AI</iWant>
    <soThat>I can ensure my privacy is respected</soThat>
    <tasks>
### Backend Development Tasks

**Task 1: Update User Model for Consent**
- [x] Subtask 1.1: Add `consent_essential` field to User model (always true)
- [x] Subtask 1.2: Add `consent_ai_training` field to User model
- [x] Subtask 1.3: Add `consent_marketing` field to User model

**Task 2: Implement Consent in Registration**
- [x] Subtask 2.1: Update `RegisterUserDto` to include consent fields
- [x] Subtask 2.2: Store consent flags during user creation
- [x] Subtask 2.3: Validate consent requirements

**Task 3: Consent Management API**
- [x] Subtask 3.1: Create endpoint to view current consent settings
- [x] Subtask 3.2: Create endpoint to update consent preferences

### Frontend Development Tasks

**Task 4: Registration Consent UI**
- [x] Subtask 4.1: Add consent checkboxes to registration form
- [x] Subtask 4.2: Display clear descriptions for each consent type
- [x] Subtask 4.3: Mark essential consent as required

**Task 5: Consent Management UI**
- [x] Subtask 5.1: Add consent section to user profile/settings
- [x] Subtask 5.2: Allow users to modify optional consents

### Testing Tasks

**Task 6: Unit Tests**
- [x] Subtask 6.1: Test consent storage during registration
- [x] Subtask 6.2: Test consent update functionality

**Task 7: Integration Tests**
- [x] Subtask 7.1: Test registration with various consent combinations
- [x] Subtask 7.2: Test consent modification endpoints
    </tasks>
  </story>

  <acceptanceCriteria>
### Functional Acceptance Criteria

* **AC-1:** Given I am a new user signing up, when I complete the registration process, then I am presented with clear, easy-to-understand options for GDPR data processing consent, including specific consent for AI training.
* **AC-2:** My consent choices *must* be securely stored and auditable.
* **AC-3:** I *must* be able to easily review and modify my consent preferences at any time.
* **AC-4:** Essential consent (required for platform operation) *must* be clearly distinguished from optional consents.
* **AC-5:** The consent UI *must* use clear, plain language without legal jargon.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Story 5.1: GDPR Consent Management (MVP)</section>
        <snippet>As a user, I want clear and granular control over my data consent preferences, including how my data is processed by AI, so that I can ensure my privacy is respected.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification</title>
        <section>5. GDPR Feature Design</section>
        <snippet>Consent management integrated into user registration flow with consent flags stored in database.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>User model</symbol>
        <lines>10-30</lines>
        <reason>User model with consent fields</reason>
      </file>
      <file>
        <path>src/services/auth.service.ts</path>
        <kind>service</kind>
        <symbol>authService.register</symbol>
        <lines>37-62</lines>
        <reason>Registration with consent handling</reason>
      </file>
      <file>
        <path>src/repositories/user.repository.ts</path>
        <kind>repository</kind>
        <symbol>userRepository.create</symbol>
        <lines>30-46</lines>
        <reason>User creation with consent fields</reason>
      </file>
      <file>
        <path>frontend/app/register/page.tsx</path>
        <kind>page</kind>
        <symbol>RegisterPage</symbol>
        <lines>1-150</lines>
        <reason>Registration form with consent checkboxes</reason>
      </file>
    </code>
    <dependencies>
      <npm>
        <package name="@prisma/client" version="^5.7.1" />
        <package name="react" version="^18.2.0" />
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Essential consent must always be true for platform use</constraint>
    <constraint>Optional consents must default to false</constraint>
    <constraint>Consent choices must be auditable</constraint>
    <constraint>UI must use plain language, not legal jargon</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>RegisterUserDto</name>
      <kind>typescript interface</kind>
      <signature>
interface RegisterUserDto {
  name: string;
  email: string;
  password: string;
  firstName?: string;
  lastName?: string;
  consent_essential?: boolean;
  consent_ai_training?: boolean;
  consent_marketing?: boolean;
}
      </signature>
      <path>src/services/auth.service.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests with Jest, integration tests with Supertest</standards>
    <locations>
      - src/tests/unit/auth.service.test.ts
      - src/tests/integration/auth.routes.test.ts
    </locations>
    <ideas>
      <idea for="AC-1">Test that consent options appear during registration</idea>
      <idea for="AC-2">Test that consent is stored in database</idea>
      <idea for="AC-3">Test consent update endpoint</idea>
    </ideas>
  </tests>
</story-context>
