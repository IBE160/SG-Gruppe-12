<story-context id="epic4/story-4-2" v="1.0">
  <metadata>
    <epicId>epic-4</epicId>
    <storyId>4-2</storyId>
    <title>AI-Driven Personalized Cover Letter Generation</title>
    <status>done</status>
    <generatedAt>2025-12-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-2-ai-driven-personalized-cover-letter-generation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>a personalized cover letter generated by AI that addresses the specific job requirements</iWant>
    <soThat>I can submit a complete and compelling application</soThat>
    <tasks>
### Backend Development Tasks

**Task 1: Implement Cover Letter Generation Endpoint**
- [x] Subtask 1.1: Create `POST /api/application/generate-cover-letter` endpoint in application routes
- [x] Subtask 1.2: Implement controller to handle request validation and response formatting
- [x] Subtask 1.3: Create prompt template in `src/prompts/cover-letter.prompt.ts`

**Task 2: Implement AI Generation Logic in ApplicationService**
- [x] Subtask 2.1: Implement `generateCoverLetter()` method in `application.service.ts`
- [x] Subtask 2.2: Integrate Vercel AI SDK with Gemini model
- [x] Subtask 2.3: Implement `callAIForCoverLetter()` with proper prompt construction
- [x] Subtask 2.4: Add JSON response parsing and validation
- [x] Subtask 2.5: Integrate LLM safety service for output sanitization
- [x] Subtask 2.6: Add bias detection for generated content

**Task 3: Data Integration**
- [x] Subtask 3.1: Fetch structured CV data from Epic 2 data model
- [x] Subtask 3.2: Fetch job analysis data from Epic 3
- [x] Subtask 3.3: Support cover letter options (tone, length, etc.)

### Testing Tasks

**Task 4: Unit Tests**
- [x] Subtask 4.1: Write unit tests for `generateCoverLetter()` method
- [x] Subtask 4.2: Test prompt template generation with various options
- [x] Subtask 4.3: Test JSON parsing and validation

**Task 5: Integration Tests**
- [x] Subtask 5.1: Write integration tests for the API endpoint
- [x] Subtask 5.2: Test error handling for invalid CV or job posting IDs
    </tasks>
  </story>

  <acceptanceCriteria>
### Functional Acceptance Criteria

* **AC-1:** Given a populated CV and an analyzed job description, when I request to generate a cover letter, then the system uses AI to create a cover letter that references my relevant qualifications and the job's requirements.
* **AC-2:** The generated cover letter *must* adhere to the defined data schema contracts for content (greeting, opening, body, closing, signature, fullText).
* **AC-3:** The AI prompt templates used *must* be versioned and consistently applied.
* **AC-4:** The generated cover letter *must* be consistent in its narrative and emphasis with the tailored CV.
* **AC-5:** The cover letter *must* include proper structure: greeting, introduction, body paragraphs, and closing.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Story 4.2: AI-Driven Personalized Cover Letter Generation (MVP)</section>
        <snippet>As a user, I want a personalized cover letter generated by AI that addresses the specific job requirements, so that I can submit a complete and compelling application.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>5.2 Tailored Cover Letter Generation</section>
        <snippet>POST /api/application/generate-cover-letter - Generates personalized cover letter</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/services/application.service.ts</path>
        <kind>service</kind>
        <symbol>applicationService.generateCoverLetter</symbol>
        <lines>129-178</lines>
        <reason>Main method for generating cover letters using AI</reason>
      </file>
      <file>
        <path>src/services/application.service.ts</path>
        <kind>service</kind>
        <symbol>applicationService.callAIForCoverLetter</symbol>
        <lines>515-552</lines>
        <reason>Calls the AI provider (Gemini) to generate cover letter content</reason>
      </file>
      <file>
        <path>src/prompts/cover-letter.prompt.ts</path>
        <kind>prompt</kind>
        <symbol>CoverLetterPrompt.v1</symbol>
        <lines>1-60</lines>
        <reason>Versioned prompt template for cover letter generation</reason>
      </file>
      <file>
        <path>src/utils/llm-safety.util.ts</path>
        <kind>utility</kind>
        <symbol>llmSafetyService.detectBias</symbol>
        <lines>50-80</lines>
        <reason>Detects biased language in generated content</reason>
      </file>
    </code>
    <dependencies>
      <npm>
        <package name="ai" version="^5.0.106" />
        <package name="@ai-sdk/google" version="^2.0.44" />
        <package name="@prisma/client" version="^5.7.1" />
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use Vercel AI SDK with Gemini 1.5 Flash model</constraint>
    <constraint>Cover letter must reference actual user qualifications only</constraint>
    <constraint>Must include bias detection for generated content</constraint>
    <constraint>Response must be valid JSON matching CoverLetterResult interface</constraint>
    <constraint>Must support customization options (tone, length)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>CoverLetterResult</name>
      <kind>typescript interface</kind>
      <signature>
export interface CoverLetterResult {
  greeting: string;
  opening: string;
  body: string[];
  closing: string;
  signature: string;
  fullText: string;
}
      </signature>
      <path>src/services/application.service.ts</path>
    </interface>
    <interface>
      <name>CoverLetterOptions</name>
      <kind>typescript interface</kind>
      <signature>
export interface CoverLetterOptions {
  tone?: 'formal' | 'professional' | 'friendly';
  length?: 'short' | 'medium' | 'long';
  emphasize?: string[];
}
      </signature>
      <path>src/prompts/cover-letter.prompt.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests with Jest, integration tests with Supertest. AI responses mocked.</standards>
    <locations>
      - src/tests/unit/application.service.test.ts
      - src/tests/integration/application.routes.test.ts
    </locations>
    <ideas>
      <idea for="AC-1">Test that cover letter references job requirements</idea>
      <idea for="AC-2">Test that response matches CoverLetterResult schema</idea>
      <idea for="AC-5">Test that all structural elements are present</idea>
    </ideas>
  </tests>
</story-context>
